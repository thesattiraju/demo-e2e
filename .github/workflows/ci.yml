name: Docker Image CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  REGISTRY_NAME: dsmsacr
  CLUSTER_NAME: ds-ms
  CLUSTER_RESOURCE_GROUP: ds-ms
  NAMESPACE: demo-e2e

jobs:
  pre-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Building the Docker image
      run: |
        docker build . --tag demo-e2e
    
    - uses: ds-ms/container-scan@releases/v0
      name: Container Scan
      id: imagescan
      continue-on-error: true
      with:
        image-name: demo-e2e
    
    - name: Docker login
      uses: azure/docker-login@v1
      with:
        login-server: dsmsacr.azurecr.io
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Push image
      run: |
        docker tag demo-e2e ${{ env.REGISTRY_NAME }}.azurecr.io/demo-e2e:${{ github.sha }}
        docker push ${{ env.REGISTRY_NAME }}.azurecr.io/demo-e2e:${{ github.sha }}

    - name: Upload Container Scan Report
      uses: github/codeql-action/upload-sarif@v1
      if: github.event.ref == 'refs/heads/master'
      with:
        sarif_file: ${{ steps.imagescan.outputs.sarif-file-path }}
  
  deploy:
    runs-on: ubuntu-latest
    needs: [pre-deploy]
    steps:
    - uses: actions/checkout@v2

    - name: Login to Azure
      uses: azure/login@v1.1
      with:
        creds: ${{secrets.AZURE_CREDENTIALS}}
    
    - name: Set Web App ACR authentication
      uses: Azure/appservice-settings@v1
      with:
        app-name: 'e2edemoapp'
        app-settings-json: |
          [
              {
                  "name": "DOCKER_REGISTRY_SERVER_PASSWORD",
                  "value": "${{ secrets.DOCKER_PASSWORD }}",
                  "slotSetting": false
              },
              {
                  "name": "DOCKER_REGISTRY_SERVER_URL",
                  "value": "${{ env.REGISTRY_NAME }}.azurecr.io",
                  "slotSetting": false
              },
              {
                  "name": "DOCKER_REGISTRY_SERVER_USERNAME",
                  "value": "${{ secrets.DOCKER_USERNAME  }}",
                  "slotSetting": false
              }
          ]

    - name: Checkout templates
      uses: actions/checkout@master
      with:
        path: templates
    
    - name: Update WebApp configuration
      run: bash ./templates/.github/scripts/updateAppConfig.sh appConfig.json subscriptions/c00d16c7-6c1f-4c03-9be1-6934a4c49682/resourceGroups/az-pac-demo/providers/Microsoft.Web/sites/e2edemoapp
    
    - name: Deploy
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'e2edemoapp'
        images: ${{ env.REGISTRY_NAME }}.azurecr.io/demo-e2e:${{ github.sha }}

  post-deploy:
    runs-on: ubuntu-latest
    needs: [deploy]
    steps:
    - uses: ds-ms/asc-assessment@master
      name: "Create Assessment"
      with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          resource-group: ${{ env.CLUSTER_RESOURCE_GROUP }}
          cluster-name:  ${{ env.CLUSTER_NAME }}
          severity: Medium

    - name: Login to Azure
      uses: azure/login@v1.1
      with:
        creds: ${{secrets.AZURE_CREDENTIALS}}

    - name: Check resource policy compliance post deployment
      uses: ajinkya599/AzPac@release-1.0.0
      with:
        scopes: |
          /subscriptions/c00d16c7-6c1f-4c03-9be1-6934a4c49682/resourcegroups/az-pac-demo/providers/Microsoft.Web/sites/e2edemoapp
